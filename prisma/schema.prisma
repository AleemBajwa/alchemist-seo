generator client {
  provider = "prisma-client-js"
}

// PostgreSQL for production (Neon, Supabase, etc.)
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  clerkId         String           @unique
  email           String
  name            String?
  stripeCustomerId String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  projects        Project[]
  apiKeys         UserApiKey[]
  auditRuns       AuditRun[]
  whiteLabel      WhiteLabel?
  subscription    Subscription?
  domainSnapshots DomainSnapshot[]
  apiKeysDev      ApiKey[]
}

model Subscription {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripePriceId     String?
  stripeSubscriptionId String?
  status            String   @default("inactive")
  currentPeriodEnd  DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model WhiteLabel {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName String?
  logoUrl     String?
  primaryColor String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserApiKey {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider    String
  login       String?
  password    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, provider])
}

model Project {
  id          String   @id @default(cuid())
  name        String
  domain      String
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  keywords    Keyword[]
  keywordFolders KeywordFolder[]
  auditRuns   AuditRun[]
  trackedKeywords TrackedKeyword[]
}

model Keyword {
  id          String   @id @default(cuid())
  keyword     String
  volume      Int?
  difficulty  Int?
  cpc         Float?
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  folderId    String?
  folder      KeywordFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
}

model KeywordFolder {
  id          String   @id @default(cuid())
  name        String
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  keywords    Keyword[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([projectId, name])
}

model TrackedKeyword {
  id             String           @id @default(cuid())
  keyword        String
  domain         String?
  projectId      String
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  position       Int?
  url            String?
  lastChecked    DateTime?
  createdAt      DateTime        @default(now())
  positionHistory PositionHistory[]
}

model PositionHistory {
  id               String         @id @default(cuid())
  trackedKeywordId String
  trackedKeyword   TrackedKeyword @relation(fields: [trackedKeywordId], references: [id], onDelete: Cascade)
  position         Int?
  url              String?
  checkedAt        DateTime       @default(now())
}

model AuditRun {
  id          String   @id @default(cuid())
  url         String
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      String
  score       Int
  grade       String
  issues      String
  pagesCount  Int?     @default(1)
  crawlType   String?  @default("single")
  createdAt   DateTime @default(now())
}

model DomainSnapshot {
  id              String   @id @default(cuid())
  domain          String
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  etv             Float?
  keywordCount    Int?
  rank            Int?
  backlinks       Int?
  referringDomains Int?
  snapshotMonth   String
  createdAt       DateTime @default(now())

  @@unique([domain, userId, snapshotMonth])
  @@index([userId, domain])
}

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  keyHash     String   @unique
  keyPrefix   String
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())

  @@index([keyHash])
}

